name: macOS VNC via Bore (Final Stable)

on:
  workflow_dispatch:

jobs:
  macos-vnc:
    runs-on: ubuntu-22.04
    timeout-minutes: 240   # 4 hours

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          qemu-kvm libvirt-daemon-system libvirt-clients \
          bridge-utils virt-manager curl wget unzip

    - name: Install Bore (Stable Binary)
      run: |
        wget https://github.com/ekzhang/bore/releases/download/v0.4.0/bore-v0.4.0-x86_64-unknown-linux-musl.tar.gz
        tar -xzf bore-v0.4.0-x86_64-unknown-linux-musl.tar.gz
        sudo mv bore /usr/local/bin/bore
        sudo chmod +x /usr/local/bin/bore
        bore --version

    - name: Download macOS-Simple-KVM
      run: |
        git clone https://github.com/foxlet/macOS-Simple-KVM.git

    - name: Prepare macOS VM
      run: |
        cd macOS-Simple-KVM
        ./jumpstart.sh --mojave

    - name: Start macOS VM (VNC on 5900)
      run: |
        cd macOS-Simple-KVM
        nohup ./basic.sh > vm.log 2>&1 &
        sleep 25

    - name: Expose VNC Port 5900 with Bore
      run: |
        nohup bore local 5900 --to bore.pub > bore.log 2>&1 &
        sleep 8
        echo "===== BORE LOG ====="
        cat bore.log

    - name: Display VNC Connection Info & Keep Alive
      run: |
        echo "======================================"
        echo "VNC CONNECTION INFORMATION"
        echo "Method : Bore"
        echo "Port   : 5900"
        echo "--------------------------------------"
        grep -o 'bore.pub:[0-9]*' bore.log || echo "Waiting for address..."
        echo "======================================"
        sleep 14400
