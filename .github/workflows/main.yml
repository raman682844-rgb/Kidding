name: Ubuntu RDP Access (Test Mode)

on:
  workflow_dispatch:
    inputs:
      connection_method:
        description: "Choose connection method (ngrok / tailscale / bore)"
        required: true
        default: "ngrok"
      runtime:
        description: "Runtime in minutes"
        required: true
        default: "360"

env:
  NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}

jobs:
  rdp:
    runs-on: ubuntu-latest

    steps:
      # =======================
      # UPDATE SYSTEM
      # =======================
      - name: Update System
        run: sudo apt update

      # =======================
      # INSTALL DESKTOP + XRDP
      # =======================
      - name: Install Desktop & XRDP
        run: |
          sudo apt install -y ubuntu-desktop-minimal xrdp
          sudo systemctl enable xrdp
          sudo systemctl restart xrdp
          sudo adduser xrdp ssl-cert

      # =======================
      # CREATE RDP USER
      # =======================
      - name: Create RDP User (TEST MODE)
        run: |
          sudo useradd -m rdpuser || true
          echo "rdpuser:Kdjrbtbtvrcrc27336@wfwfavsc154$34415_255wgefcWrfe" | sudo chpasswd
          sudo usermod -aG sudo rdpuser

          echo "===================================="
          echo "RDP LOGIN DETAILS (TEST MODE)"
          echo "Username : rdpuser"
          echo "Password : Kdjrbtbtvrcrc27336@wfwfavsc154$34415_255wgefcWrfe"
          echo "===================================="

      # =======================
      # FIX BLACK SCREEN
      # =======================
      - name: XRDP Session Fix
        run: |
          echo "export GNOME_SHELL_SESSION_MODE=ubuntu" >> /home/rdpuser/.xsession
          echo "export XDG_SESSION_TYPE=x11" >> /home/rdpuser/.xsession
          sudo chown rdpuser:rdpuser /home/rdpuser/.xsession

      # =======================
      # SETUP TUNNEL
      # =======================
      - name: Setup Connection Tunnel
        shell: bash
        run: |
          METHOD="${{ github.event.inputs.connection_method }}"

          if [ "$METHOD" = "ngrok" ]; then
            echo ">>> Using NGROK"

            curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc \
              | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
            echo "deb https://ngrok-agent.s3.amazonaws.com buster main" \
              | sudo tee /etc/apt/sources.list.d/ngrok.list
            sudo apt update
            sudo apt install -y ngrok

            ngrok config add-authtoken "$NGROK_AUTH_TOKEN"

            ngrok tcp 3389 --log=stdout > ngrok.log &

            sleep 8

            PUBLIC_URL=$(curl -s http://127.0.0.1:4040/api/tunnels \
              | jq -r '.tunnels[0].public_url')

            echo "CONNECTION_TYPE=Ngrok" >> $GITHUB_ENV
            echo "CONNECTION_URL=$PUBLIC_URL" >> $GITHUB_ENV

          elif [ "$METHOD" = "tailscale" ]; then
            echo ">>> Using Tailscale"

            curl -fsSL https://tailscale.com/install.sh | sh
            sudo tailscale up --ssh

            TS_IP=$(tailscale ip -4)

            echo "CONNECTION_TYPE=Tailscale" >> $GITHUB_ENV
            echo "CONNECTION_URL=$TS_IP:3389" >> $GITHUB_ENV

          elif [ "$METHOD" = "bore" ]; then
            echo ">>> Using Bore"

            wget -q https://github.com/ekzhang/bore/releases/latest/download/bore-linux-amd64
            chmod +x bore-linux-amd64
            sudo mv bore-linux-amd64 /usr/local/bin/bore

            bore local 3389 --to bore.pub &

            sleep 5

            echo "CONNECTION_TYPE=Bore" >> $GITHUB_ENV
            echo "CONNECTION_URL=bore.pub (check logs)" >> $GITHUB_ENV

          else
            echo "Invalid connection method"
            exit 1
          fi

      # =======================
      # SHOW CONNECTION INFO
      # =======================
      - name: Show RDP Connection Info
        run: |
          echo "===================================="
          echo "RDP USER     : rdpuser"
          echo "RDP PASSWORD : Kdjrbtbtvrcrc27336@wfwfavsc154$34415_255wgefcWrfe"
          echo "METHOD       : $CONNECTION_TYPE"
          echo "ADDRESS      : $CONNECTION_URL"
          echo "===================================="

      # =======================
      # KEEP RUNNER ALIVE
      # =======================
      - name: Keep Session Alive
        run: |
          sleep $(( ${{ github.event.inputs.runtime }} * 60 ))
